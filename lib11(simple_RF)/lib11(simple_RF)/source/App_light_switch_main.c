/**********************************************************************************************************************************************************
* 文 件 名：App_light_switch_main.c
×
* 功    能：实验十一 简单RF实验
*
*            本实验主要是学习怎么配置CC2530RF功能。本实验主要分为3大部分，第一部分为初始化与RF相关的信息；
*            
*          第二部分为发送数据和接收数据；最后为选择模块功能函数。其中模块功能的选择是通过开发板上的按键来
*          
*          选择的，其中按键功能分配如下：
*                SW1 --- 开始测试（进入功能选择菜单）
*                SW2 --- 设置模块为接收功能（Light）
*                SW3 --- 设置模块为发送功能（Switch）
*                SW4 --- 发送模块发送命令按键
*
*               当发送模块按下SW4时，将发射一个控制命令，接收模块在接收到该命令后，将控制LDE1的亮或者灭。
*
*               其中LED6为工作指示灯，当工作不正常时，LED5将为亮状态。
*
*
*           在\include\文件和\source\文件中包含了和RF相关的一些宏和函数，用户使用这些宏
*           和函数可以简化对CC2530的RF操作，提高代码的可读性，本实验中就使用了其中的一些宏和函数。
*
* 注    意：本实验所需硬件资源：
*           OURS-CC2530RF板 2块
*           带LCD的智能主板 2块
*           
*           
*
* 版    本：V1.0
* 作    者：wuxianhai
* 日    期：2011.2.15
* 奥尔斯科技主页：www.ourselec.com
**********************************************************************************************************************************************************/
#include "hal_board.h"
#include "hal_int.h"
#include "hal_mcu.h"
#include "hal_rf.h"
#include "basic_rf.h"
#include "LCD.h"
#include "stdio.h"

#define RF_CHANNEL                23       // 2.4 GHz RF 使用信道25

#define PAN_ID                  0x2167    // 通信PANID
#define SWITCH_ADDR              125    // 0x2530开关模块地址
#define LIGHT_ADDR            0xBEEF      //灯模块地址
#define APP_PAYLOAD_LENGTH        8       //命令长度
#define LIGHT_TOGGLE_CMD4          0       //命令数据
#define LIGHT_TOGGLE_CMD5          1       //命令数据
// 应用状态
#define IDLE                      0
#define SEND_CMD                  1

//应用角色
#define NONE                      0      
#define SEND                    1
#define RECIVE                     2
#define APP_MODES                 2

//按键
#define HAL_BUTTON_1              1
#define HAL_BUTTON_2              2
#define HAL_BUTTON_3              3
#define HAL_BUTTON_4              4
#define HAL_BUTTON_5              5
#define HAL_BUTTON_6              6

static uint8 pTxData[APP_PAYLOAD_LENGTH];  //发送数据数组
static uint8 pRxData[APP_PAYLOAD_LENGTH];  //接收数据数组

static basicRfCfg_t basicRfConfig;         //RF初始化结构体

extern void halboardinit(void);            //硬件初始化函数
extern void ctrPCA9554FLASHLED(uint8 led); //IIC灯控制函数
extern void ctrPCA9554LED(uint8 led,uint8 operation);
extern uint8 halkeycmd(void);              //获取按键值函数
int i=6;

#ifdef SECURITY_CCM                        //安全密钥
static uint8 key[]= {
    0xc0, 0xc1, 0xc2, 0xc3, 0xc4, 0xc5, 0xc6, 0xc7,
    0xc8, 0xc9, 0xca, 0xcb, 0xcc, 0xcd, 0xce, 0xcf,
};
#endif
static int count = 0;
static void appRecive();                   //灯应用处理函数
static void appSend();                  //开关应用处理函数
static uint8 appSelectMode(void);         //应用功能选择函数

/**************************************************************************************************
 * 函数名称：appLight
 *
 * 功能描述：接收模式应用函数，初始化RF一些参数，接收另一个模块发送的控制命令，然后控制相应的LED灯
 *                     
 *
 * 参    数：无
 *
 * 返 回 值：无
 **************************************************************************************************/
static void appRecive()
{
    char s[8];
    basicRfConfig.myAddr = LIGHT_ADDR;       //设置接收模块的地址
    if(basicRfInit(&basicRfConfig)==FAILED)  //RF初始化
    {
      ctrPCA9554FLASHLED(5);                 //RF初始化不成功，则所有的LED5闪烁
    }
    basicRfReceiveOn();                      //打开接收功能
    // Main loop
    while (TRUE) 
    {
        while(!basicRfPacketIsReady());      //准备接收数据
 
        if(basicRfReceive(pRxData, APP_PAYLOAD_LENGTH, NULL)>0)   //接收数据
        {
            if(pRxData[0] == LIGHT_TOGGLE_CMD4) //判断命令是否正确
            {   
                count++;
                ctrPCA9554FLASHLED(1);        //关闭或打开LED1
                sprintf(s, (char*)"%d%d",  ((INT16)((int)count/10)), ((INT16)((int)count%10)));
                GUI_PutString5_7(10,48,"jishu:");
                GUI_PutString5_7(50,48,(char *)s);
                LCM_Refresh();
            }
             else if(pRxData[0] == LIGHT_TOGGLE_CMD5) //判断命令是否正确
            {   
             // pRxData[2]
                ctrPCA9554FLASHLED(2);        //关闭或打开LED1
                 sprintf(s, (char*)"%d%d%d%d%d%d%d%d", ((INT16)((int)pRxData[1]/ 10000000)),((INT16)((int)pRxData[1]/ 1000000)),((INT16)((int)pRxData[1]/ 100000)),((INT16)((int)pRxData[1]/ 10000)),((INT16)((int)pRxData[1]/ 1000)),((INT16)((int)pRxData[1]/ 100)), ((INT16)((int)pRxData[1]/ 10)), ((INT16)((int)pRxData[1] % 10)));
        
                 GUI_PutString5_7(10,48,"xulie:");
                 GUI_PutString5_7(50,48,(char*)s);
                LCM_Refresh();
                
            }
        }
    }
}

/**************************************************************************************************
 * 函数名称：appSwitch
 *
 * 功能描述：发送模式应用函数，初始化发送模式RF，通过按下SW4向另一个模块发送控制命令。
 *                     
 *
 * 参    数：无
 *
 * 返 回 值：无
 **************************************************************************************************/
static void appSend()
{
    

    basicRfConfig.myAddr = SWITCH_ADDR;         //设置发送模块的地址
    
    if(basicRfInit(&basicRfConfig)==FAILED)     //RF初始化
    {
      ctrPCA9554FLASHLED(5);                    //RF初始化不成功，则所有的LED5闪烁
    }

    basicRfReceiveOff();                        //关闭接收功能
    // Main loop
    while (TRUE) 
    {
        if(halkeycmd() == HAL_BUTTON_4)         //判断是否按下SW4
        {
            pTxData[0] = LIGHT_TOGGLE_CMD4;              //向发送数据中写入命令
            basicRfSendPacket(LIGHT_ADDR, pTxData, APP_PAYLOAD_LENGTH);//发送数据

            halIntOff();                                               //关闭全局中断

            halIntOn();                                               //打开中断
             
        }
        else if(halkeycmd() == HAL_BUTTON_5)
        {
             pTxData[0] = LIGHT_TOGGLE_CMD5;              //向发送数据中写入命令
            basicRfSendPacket(LIGHT_ADDR, pTxData, APP_PAYLOAD_LENGTH);//发送数据

            halIntOff();                                               //关闭全局中断

            halIntOn();                                               //打开中断
         }
    }
}

/**************************************************************************************************
 * 函数名称：appSelectMode
 *
 * 功能描述：通过SW2或SW3选择模块的应用模式。
 *                     
 *
 * 参    数：无
 *
 * 返 回 值：LIGHT -- 接收模式
 *           SWITCH -- 发送模式
 *           NONE -- 不正确模式
 *
 **************************************************************************************************/
static uint8 appSelectMode(void)        
{
  uint8 key;
  GUI_ClearScreen();                             //LCD清屏
  GUI_PutString5_7(25,6,"OURS-CC2530");          //在LCD上显示相应的文字             
  GUI_PutString5_7(10,22,"Device Mode: ");                          
  GUI_PutString5_7(10,35,"SW2 -> RECIVE");
  GUI_PutString5_7(10,48,"SW3 -> SEND");
  LCM_Refresh();
 do 
 {
   key = halkeycmd();
 }while(key == HAL_BUTTON_1);                    //等待模式选择
    if(key == HAL_BUTTON_2)                      //接收模式
    {
      GUI_ClearScreen();
      GUI_PutString5_7(25,6,"OURS-CC2530");      //在LCD上显示相应的文字              
      GUI_PutString5_7(10,22,"Device Mode: ");                          
      GUI_PutString5_7(10,35,"Recive");
       
      char s[5];
              sprintf(s, "%d",i);
      //GUI_PutString5_7(10,45,"Light");
      //GUI_PutString5_7(10,45，(char *)s);
              LCM_Refresh();
      
      return RECIVE;
    }
     if(key == HAL_BUTTON_3)                     //发送模式
    {
      GUI_ClearScreen();
      GUI_PutString5_7(25,6,"OURS-CC2530");      //在LCD上显示相应的文字          
      GUI_PutString5_7(10,22,"Device Mode: ");                            
      GUI_PutString5_7(10,35,"SW4 Send Command 1");
      GUI_PutString5_7(10,48,"SW5 Send Command 2");
      LCM_Refresh();
      
      return SEND;
    }
    return NONE;        
}

/**************************************************************************************************
 * 函数名称：main
 *
 * 功能描述：通过不同的按键，设置模块的应用角色（接收模式或发送模式）。通过SW4发送控制命令
 *                     
 *
 * 参    数：无
 *
 * 返 回 值：无
 **************************************************************************************************/
void main(void)
{
    
    uint8 appMode = NONE;                     //应用职责（角色）初始化

    basicRfConfig.panId = PAN_ID;             //配置PANID  2011
    basicRfConfig.channel = RF_CHANNEL;       //设置信道   22
    basicRfConfig.ackRequest = TRUE;          //需要ACK请求
    
#ifdef SECURITY_CCM                           //编译选项（未选）
    basicRfConfig.securityKey = key;          // 安全密钥
#endif
    
    halboardinit();                           //初始化板的外围设备(包括LED LCD 和按键等)

    if(halRfInit()==FAILED)                  //初始化RF
    {                    
      ctrPCA9554FLASHLED(5);                 //RF初始化不成功，则所有的LED5闪烁
    }

    ctrPCA9554FLASHLED(6);                   //点亮LED6，以指示设备正常运行       
    
    GUI_PutString5_7(10,22,"Simple RF test");//在LCD上显示相应的文字
    GUI_PutString5_7(10,35,"SW1 -> START");
    LCM_Refresh();

    while (halkeycmd() != HAL_BUTTON_1);     //等待按键1按下  ，进入下一级菜单
    halMcuWaitMs(350);                       //延时350MS

    appMode = appSelectMode();               //设置应用职责（角色） 同时在LCD上显示相应的设置信息

    if(appMode == SEND)                    //发送模式
    {
        ctrPCA9554LED(2,1);
        appSend();                         //执行发送模式功能
    }
    else if(appMode == RECIVE)                //接收模式
    {
        ctrPCA9554LED(3,1);
        appRecive();                         //执行接收模式功能
        
    }
}




